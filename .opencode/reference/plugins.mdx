---
title: Plugins
description: Write your own plugins to extend OpenCode.
---

Plugins allow you to extend OpenCode by hooking into various events and customizing behavior. You can create plugins to add new features, integrate with external services, or modify OpenCode's default behavior.

For examples, check out the [plugins](/docs/ecosystem#plugins) created by the community.

:::note
**Implementation reference**: See the [plugin loader](https://github.com/itlackey/opencode/blob/main/packages/opencode/src/plugin/index.ts) and [type definitions](https://github.com/itlackey/opencode/blob/main/packages/plugin/src/index.ts) in the source code for implementation details.
:::

---

## Create a plugin

A plugin is a **JavaScript/TypeScript module** that exports one or more plugin
functions. Each function receives a context object and returns a hooks object.

---

### Location

Plugins are loaded from:

1. `.opencode/plugin` directory in your project
2. Globally in `~/.config/opencode/plugin`

Plugins can also be installed from:

- **npm packages**: Add plugin names to your config (see [Installation](#installation))
- **GitHub repositories**: Reference GitHub repos directly in your config
- **Local file paths**: Use `file://` URLs for local development

> **Implementation**: Plugin loading is handled in [config.ts](https://github.com/itlackey/opencode/blob/main/packages/opencode/src/config/config.ts#L291-L304) and [plugin/index.ts](https://github.com/itlackey/opencode/blob/main/packages/opencode/src/plugin/index.ts#L29-L46)

---

### Basic structure

```js title=".opencode/plugin/example.js"
export const MyPlugin = async ({ project, client, $, directory, worktree }) => {
  console.log("Plugin initialized!")

  return {
    // Hook implementations go here
  }
}
```

The plugin function receives a `PluginInput` object with:

- `project`: Project metadata including name, git info, and paths
- `directory`: The current working directory (absolute path)
- `worktree`: The git worktree root path
- `client`: OpenCode SDK client for AI interactions, session management, and API calls
- `$`: Bun's [shell API](https://bun.com/docs/runtime/shell) for executing commands

> **Type definition**: [`PluginInput`](https://github.com/itlackey/opencode/blob/main/packages/plugin/src/index.ts#L26-L32) in `@opencode-ai/plugin`

---

### TypeScript support

For TypeScript plugins, import types from the plugin package:

```ts title="my-plugin.ts" {1}
import type { Plugin } from "@opencode-ai/plugin"

export const MyPlugin: Plugin = async ({ project, client, $, directory, worktree }) => {
  return {
    // Type-safe hook implementations
  }
}
```

> **Type definition**: [`Plugin`](https://github.com/itlackey/opencode/blob/main/packages/plugin/src/index.ts#L34) type in `@opencode-ai/plugin`

---

## Installation

> **Implementation**: Plugin installation is handled by [`BunProc.install()`](https://github.com/itlackey/opencode/blob/main/packages/opencode/src/bun/index.ts#L63-L113)

### From config file

Add plugins to your `opencode.json` or `opencode.jsonc` configuration:

```json title=".opencode/opencode.json"
{
  "plugin": [
    "opencode-wakatime@1.0.0",
    "opencode-helicone-session",
    "github:username/my-plugin-repo",
    "file:///absolute/path/to/plugin"
  ]
}
```

### From npm packages

Install published npm packages by specifying the package name with an optional version:

```json
{
  "plugin": ["opencode-anthropic-auth@0.0.5", "opencode-copilot-auth"]
}
```

OpenCode will automatically install the plugin from npm using Bun's package manager.

### From GitHub repositories

Reference GitHub repositories directly:

```json
{
  "plugin": ["github:H2Shami/opencode-helicone-session"]
}
```

### From local files

Use `file://` URLs for local development:

```json
{
  "plugin": ["file:///home/user/.opencode/plugin/my-plugin.js"]
}
```

---

## Plugin lifecycle

Plugins go through the following lifecycle:

1. **Loading**: OpenCode loads plugins from config and local directories
2. **Initialization**: Each plugin function is called with `PluginInput`
3. **Hook registration**: Plugin returns a `Hooks` object to register handlers
4. **Hook execution**: OpenCode calls hooks when events occur or at specific lifecycle points

### Plugin methods

OpenCode exposes these methods for plugin management:

- `Plugin.init()`: Initialize all plugins and subscribe to events
- `Plugin.trigger(name, input, output)`: Trigger a specific hook across all plugins
- `Plugin.list()`: Get list of all loaded plugin hooks

> **Implementation**: See [`Plugin.init()`](https://github.com/itlackey/opencode/blob/main/packages/opencode/src/plugin/index.ts#L76-L91), [`Plugin.trigger()`](https://github.com/itlackey/opencode/blob/main/packages/opencode/src/plugin/index.ts#L55-L70), and [`Plugin.list()`](https://github.com/itlackey/opencode/blob/main/packages/opencode/src/plugin/index.ts#L72-L74) in the source code

---

## Available hooks

Plugins can implement any of the following hooks to extend OpenCode's behavior:

> **Type definition**: All hooks are defined in the [`Hooks` interface](https://github.com/itlackey/opencode/blob/main/packages/plugin/src/index.ts#L145-L192)

### Configuration hook

Modify OpenCode's configuration at startup:

> **Hook definition**: [`config` hook](https://github.com/itlackey/opencode/blob/main/packages/plugin/src/index.ts#L147) | **Usage**: Called in [`Plugin.init()`](https://github.com/itlackey/opencode/blob/main/packages/opencode/src/plugin/index.ts#L78-L81)

```ts title=".opencode/plugin/config-modifier.ts"
import type { Plugin } from "@opencode-ai/plugin"

export const ConfigModifier: Plugin = async (ctx) => {
  return {
    config: async (config) => {
      // Modify the configuration object
      config.theme = "custom-theme"
      config.model = "anthropic/claude-3-5-sonnet-20241022"
      
      // Add custom agents
      if (!config.agent) config.agent = {}
      config.agent["custom"] = {
        prompt: "You are a helpful assistant",
        model: "anthropic/claude-3-5-sonnet-20241022",
      }
    },
  }
}
```

The `config` hook receives the full OpenCode configuration and can modify it in place. This runs after all config files are loaded but before plugins are fully initialized.

---

### Event hook

Subscribe to system-wide events:

> **Hook definition**: [`event` hook](https://github.com/itlackey/opencode/blob/main/packages/plugin/src/index.ts#L146) | **Usage**: Subscribed to event bus in [`Plugin.init()`](https://github.com/itlackey/opencode/blob/main/packages/opencode/src/plugin/index.ts#L82-L89)

```ts title=".opencode/plugin/event-logger.ts"
import type { Plugin } from "@opencode-ai/plugin"

export const EventLogger: Plugin = async (ctx) => {
  return {
    event: async ({ event }) => {
      if (event.type === "session.idle") {
        console.log("Session completed:", event)
      }
      
      if (event.type === "file.edited") {
        console.log("File edited:", event)
      }
      
      if (event.type === "tool.execute.after") {
        console.log("Tool executed:", event)
      }
    },
  }
}
```

#### Available events

##### Command Events
- `command.executed`: Command finished executing

##### File Events
- `file.edited`: File was edited by OpenCode
- `file.watcher.updated`: File system watcher detected changes

##### Installation Events
- `installation.updated`: OpenCode installation was updated

##### LSP Events
- `lsp.client.diagnostics`: LSP diagnostics received
- `lsp.updated`: LSP server status changed

##### Message Events
- `message.part.removed`: Message part was removed
- `message.part.updated`: Message part was updated
- `message.removed`: Message was removed
- `message.updated`: Message was updated

##### Permission Events
- `permission.replied`: User responded to permission request
- `permission.updated`: Permission settings changed

##### Server Events
- `server.connected`: Connected to OpenCode server

##### Session Events
- `session.created`: New session created
- `session.compacted`: Session was compacted
- `session.deleted`: Session was deleted
- `session.diff`: Session diff generated
- `session.error`: Session encountered an error
- `session.idle`: Session became idle (finished processing)
- `session.status`: Session status changed
- `session.updated`: Session was updated

##### Todo Events
- `todo.updated`: Todo item was updated

##### Tool Events
- `tool.execute.after`: After a tool executes
- `tool.execute.before`: Before a tool executes

##### TUI Events
- `tui.prompt.append`: Text appended to prompt
- `tui.command.execute`: Command executed in TUI
- `tui.toast.show`: Toast notification shown

---

### Tool hooks

> **Hook definitions**: [`tool`](https://github.com/itlackey/opencode/blob/main/packages/plugin/src/index.ts#L148-L150), [`tool.execute.before`](https://github.com/itlackey/opencode/blob/main/packages/plugin/src/index.ts#L167-L170), [`tool.execute.after`](https://github.com/itlackey/opencode/blob/main/packages/plugin/src/index.ts#L171-L178) | **Tool helper**: [`tool()` function](https://github.com/itlackey/opencode/blob/main/packages/plugin/src/tool.ts#L10-L17)

#### Custom tools

Add custom tools that OpenCode can use:

```ts title=".opencode/plugin/custom-tools.ts"
import { type Plugin, tool } from "@opencode-ai/plugin"

export const CustomToolsPlugin: Plugin = async (ctx) => {
  return {
    tool: {
      get_weather: tool({
        description: "Get current weather for a location",
        args: {
          location: tool.schema.string().describe("City name or zip code"),
          units: tool.schema.enum(["celsius", "fahrenheit"]).optional(),
        },
        async execute(args, context) {
          // context contains: sessionID, messageID, agent, abort signal
          const weather = await fetch(
            `https://api.weather.com/v1/current?location=${args.location}`
          )
          return `Weather in ${args.location}: ${await weather.text()}`
        },
      }),
    },
  }
}
```

The `tool` helper provides TypeScript type safety using Zod schemas. The `execute` function receives:
- `args`: Parsed and validated arguments matching your schema
- `context`: Object with `sessionID`, `messageID`, `agent`, and `abort` signal

#### Tool execution hooks

Intercept tool calls before or after execution:

```ts title=".opencode/plugin/tool-interceptor.ts"
import type { Plugin } from "@opencode-ai/plugin"

export const ToolInterceptor: Plugin = async (ctx) => {
  return {
    "tool.execute.before": async (input, output) => {
      // input: { tool: string, sessionID: string, callID: string }
      // output: { args: any }
      
      console.log(`About to execute: ${input.tool}`)
      
      // Modify arguments
      if (input.tool === "bash" && output.args.command.includes("rm -rf")) {
        throw new Error("Dangerous command blocked")
      }
    },
    
    "tool.execute.after": async (input, output) => {
      // output: { title: string, output: string, metadata: any }
      
      console.log(`Tool ${input.tool} completed`)
      
      // Modify output
      if (input.tool === "bash") {
        output.output = `[Logged] ${output.output}`
      }
    },
  }
}
```

---

### Chat hooks

> **Hook definitions**: [`chat.message`](https://github.com/itlackey/opencode/blob/main/packages/plugin/src/index.ts#L155-L158), [`chat.params`](https://github.com/itlackey/opencode/blob/main/packages/plugin/src/index.ts#L162-L165)

#### Message hook

Process new messages:

```ts title=".opencode/plugin/message-processor.ts"
import type { Plugin } from "@opencode-ai/plugin"

export const MessageProcessor: Plugin = async (ctx) => {
  return {
    "chat.message": async (input, output) => {
      // input: { sessionID, agent?, model?, messageID? }
      // output: { message: UserMessage, parts: Part[] }
      
      console.log(`New message in session ${input.sessionID}`)
      
      // Modify message parts before they're processed
      for (const part of output.parts) {
        if (part.type === "text") {
          // Add preprocessing
        }
      }
    },
  }
}
```

#### Parameters hook

Modify LLM parameters before requests:

```ts title=".opencode/plugin/params-modifier.ts"
import type { Plugin } from "@opencode-ai/plugin"

export const ParamsModifier: Plugin = async (ctx) => {
  return {
    "chat.params": async (input, output) => {
      // input: { sessionID, agent, model, provider, message }
      // output: { temperature, topP, options }
      
      // Adjust temperature based on agent
      if (input.agent === "explore") {
        output.temperature = 0.9
      }
      
      // Add custom provider options
      output.options["custom_header"] = "value"
    },
  }
}
```

---

### Permission hook

Control permission requests:

> **Hook definition**: [`permission.ask`](https://github.com/itlackey/opencode/blob/main/packages/plugin/src/index.ts#L166)

```ts title=".opencode/plugin/auto-allow.ts"
import type { Plugin } from "@opencode-ai/plugin"

export const AutoAllow: Plugin = async (ctx) => {
  return {
    "permission.ask": async (input, output) => {
      // input: Permission object with tool, args, etc.
      // output: { status: "ask" | "deny" | "allow" }
      
      // Auto-allow safe tools
      if (input.tool === "read" && !input.args?.filePath?.includes(".env")) {
        output.status = "allow"
      }
      
      // Auto-deny dangerous operations
      if (input.tool === "bash" && input.args?.command?.includes("rm -rf /")) {
        output.status = "deny"
      }
    },
  }
}
```

---

### Authentication hook

Add custom authentication providers:

> **Hook definition**: [`auth`](https://github.com/itlackey/opencode/blob/main/packages/plugin/src/index.ts#L151) | **AuthHook type**: [`AuthHook` interface](https://github.com/itlackey/opencode/blob/main/packages/plugin/src/index.ts#L36-L102)

```ts title=".opencode/plugin/custom-auth.ts"
import type { Plugin } from "@opencode-ai/plugin"

export const CustomAuth: Plugin = async (ctx) => {
  return {
    auth: {
      provider: "custom-provider",
      methods: [
        {
          type: "oauth",
          label: "Sign in with Custom Provider",
          prompts: [
            {
              type: "text",
              key: "clientId",
              message: "Enter your client ID",
              validate: (value) => {
                if (!value) return "Client ID is required"
                return undefined
              },
            },
          ],
          async authorize(inputs) {
            const authUrl = `https://provider.com/oauth?client_id=${inputs?.clientId}`
            
            return {
              method: "auto",
              url: authUrl,
              instructions: "Sign in via browser",
              async callback() {
                // Handle OAuth callback
                return {
                  type: "success",
                  key: "auth-token",
                  provider: "custom-provider",
                }
              },
            }
          },
        },
        {
          type: "api",
          label: "Use API Key",
          prompts: [
            {
              type: "text",
              key: "apiKey",
              message: "Enter your API key",
              placeholder: "sk-...",
            },
          ],
          async authorize(inputs) {
            // Validate API key
            return {
              type: "success",
              key: inputs?.apiKey || "",
            }
          },
        },
      ],
    },
  }
}
```

---

### Experimental hooks

:::warning
Experimental hooks may change in future versions without notice.
:::

> **Hook definitions**: [`experimental.chat.messages.transform`](https://github.com/itlackey/opencode/blob/main/packages/plugin/src/index.ts#L179-L187), [`experimental.text.complete`](https://github.com/itlackey/opencode/blob/main/packages/plugin/src/index.ts#L188-L191)

#### Messages transform

Transform message history before sending to LLM:

```ts
"experimental.chat.messages.transform": async (input, output) => {
  // Modify messages array
  output.messages = output.messages.filter(m => m.info.role !== "system")
}
```

#### Text completion

Modify text completion results:

```ts
"experimental.text.complete": async (input, output) => {
  // input: { sessionID, messageID, partID }
  // output: { text: string }
  output.text = output.text.trim()
}
```

---

## Examples

Here are comprehensive examples of plugins demonstrating various capabilities.

---

### Send notifications

Send notifications when certain events occur:

```js title=".opencode/plugin/notification.js"
export const NotificationPlugin = async ({ project, client, $, directory, worktree }) => {
  return {
    event: async ({ event }) => {
      // Send notification on session completion
      if (event.type === "session.idle") {
        await $`osascript -e 'display notification "Session completed!" with title "OpenCode"'`
      }
      
      // Notify on errors
      if (event.type === "session.error") {
        await $`osascript -e 'display notification "Session error occurred" with title "OpenCode" sound name "Basso"'`
      }
    },
  }
}
```

Uses `osascript` to run AppleScript on macOS for native notifications.

---

### File protection

Prevent OpenCode from reading or editing sensitive files:

```ts title=".opencode/plugin/file-protection.ts"
import type { Plugin } from "@opencode-ai/plugin"

export const FileProtection: Plugin = async (ctx) => {
  const protectedPatterns = [".env", ".env.local", "secrets", "private.key"]
  
  return {
    "tool.execute.before": async (input, output) => {
      const path = output.args.filePath || output.args.path
      
      if (input.tool === "read" || input.tool === "edit") {
        const isProtected = protectedPatterns.some(pattern => 
          path?.includes(pattern)
        )
        
        if (isProtected) {
          throw new Error(`Access denied: ${path} is protected`)
        }
      }
      
      // Block dangerous bash commands
      if (input.tool === "bash") {
        const dangerous = ["rm -rf /", "mkfs", "dd if=", "> /dev/sda"]
        const cmd = output.args.command
        
        if (dangerous.some(d => cmd.includes(d))) {
          throw new Error("Dangerous command blocked")
        }
      }
    },
  }
}
```

---

### Plugin with external dependencies

Install and use npm packages in your plugin:

```ts title=".opencode/plugin/github-integration.ts"
import type { Plugin } from "@opencode-ai/plugin"
import { tool } from "@opencode-ai/plugin"
// Import external dependencies at top level
import { Octokit } from "octokit"

export const GitHubIntegration: Plugin = async (ctx) => {
  // Initialize external library
  // Make sure to add dependencies to package.json in .opencode/plugin/
  const octokit = new Octokit({
    auth: process.env.GITHUB_TOKEN,
  })
  
  return {
    tool: {
      create_github_issue: tool({
        description: "Create a GitHub issue in the current repository",
        args: {
          title: tool.schema.string().describe("Issue title"),
          body: tool.schema.string().describe("Issue description"),
          labels: tool.schema.array(tool.schema.string()).optional(),
        },
        async execute(args, context) {
          const [owner, repo] = ctx.project.name.split("/")
          
          const result = await octokit.rest.issues.create({
            owner,
            repo,
            title: args.title,
            body: args.body,
            labels: args.labels,
          })
          
          return `Created issue #${result.data.number}: ${result.data.html_url}`
        },
      }),
    },
  }
}
```

To use external dependencies, create a `package.json` in `.opencode/plugin/`:

```json title=".opencode/plugin/package.json"
{
  "dependencies": {
    "octokit": "^3.1.0"
  }
}
```

Then run `bun install` in the plugin directory.

---

### Plugin referencing additional files

Load templates, configs, or data files from your plugin directory:

```ts title=".opencode/plugin/template-loader.ts"
import type { Plugin } from "@opencode-ai/plugin"
import { tool } from "@opencode-ai/plugin"
import path from "path"

export const TemplateLoader: Plugin = async (ctx) => {
  // Plugin directory is in .opencode/plugin/
  const pluginDir = path.join(ctx.directory, ".opencode/plugin")
  
  // Load template file
  const templatePath = path.join(pluginDir, "templates/api-endpoint.md")
  const template = await Bun.file(templatePath).text()
  
  // Load config file
  const configPath = path.join(pluginDir, "config/plugin-settings.json")
  const settings = await Bun.file(configPath).json()
  
  return {
    tool: {
      generate_from_template: tool({
        description: "Generate code from template",
        args: {
          name: tool.schema.string(),
          type: tool.schema.enum(["api", "component", "test"]),
        },
        async execute(args, context) {
          // Use loaded template
          let output = template
          output = output.replace("{{NAME}}", args.name)
          output = output.replace("{{TYPE}}", args.type)
          
          return output
        },
      }),
    },
  }
}
```

Create template files in your plugin directory:

```markdown title=".opencode/plugin/templates/api-endpoint.md"
# API Endpoint: {{NAME}}

Type: {{TYPE}}

## Implementation

```typescript
export async function {{NAME}}(req: Request): Promise<Response> {
  // Implementation here
}
```
```

---

### Plugin downloading utilities

Download and cache external utilities:

```ts title=".opencode/plugin/external-tool.ts"
import type { Plugin } from "@opencode-ai/plugin"
import { tool } from "@opencode-ai/plugin"
import path from "path"
import os from "os"

export const ExternalTool: Plugin = async (ctx) => {
  const cacheDir = path.join(os.homedir(), ".cache/opencode/plugins/external-tool")
  await ctx.$`mkdir -p ${cacheDir}`
  
  // Download utility if not cached
  const binaryPath = path.join(cacheDir, "tool")
  const binaryExists = await Bun.file(binaryPath).exists()
  
  if (!binaryExists) {
    console.log("Downloading external tool...")
    await ctx.$`curl -L https://example.com/tool -o ${binaryPath}`
    await ctx.$`chmod +x ${binaryPath}`
  }
  
  return {
    tool: {
      run_external_tool: tool({
        description: "Run downloaded external tool",
        args: {
          input: tool.schema.string().describe("Input for the tool"),
        },
        async execute(args, context) {
          const result = await ctx.$`${binaryPath} ${args.input}`.text()
          return result
        },
      }),
    },
  }
}
```

---

### Configuration modifier

Dynamically modify OpenCode configuration:

```ts title=".opencode/plugin/config-manager.ts"
import type { Plugin } from "@opencode-ai/plugin"

export const ConfigManager: Plugin = async (ctx) => {
  return {
    config: async (config) => {
      // Set default model based on environment
      if (process.env.USE_FAST_MODEL === "true") {
        config.model = "anthropic/claude-3-haiku-20240307"
      } else {
        config.model = "anthropic/claude-3-5-sonnet-20241022"
      }
      
      // Add custom agents
      if (!config.agent) config.agent = {}
      
      config.agent["documentation"] = {
        prompt: "You are a technical documentation expert. Focus on clarity and completeness.",
        model: "anthropic/claude-3-5-sonnet-20241022",
        temperature: 0.3,
        tools: {
          bash: false, // Disable bash for documentation agent
        },
      }
      
      // Add custom commands
      if (!config.command) config.command = {}
      
      config.command["review"] = {
        template: "Review this code for best practices and potential issues",
        agent: "general",
      }
      
      // Modify permissions
      if (!config.permission) config.permission = {}
      config.permission.bash = "ask"
      config.permission.edit = "allow"
      
      // Add custom keybinds
      if (!config.keybinds) config.keybinds = {}
      config.keybinds.custom_action = "<leader>p"
    },
  }
}
```

---

### Analytics and logging

Track usage and log events:

```ts title=".opencode/plugin/analytics.ts"
import type { Plugin } from "@opencode-ai/plugin"
import path from "path"

export const Analytics: Plugin = async (ctx) => {
  const logFile = path.join(ctx.directory, ".opencode/analytics.jsonl")
  
  async function logEvent(event: any) {
    const entry = JSON.stringify({
      timestamp: new Date().toISOString(),
      project: ctx.project.name,
      ...event,
    })
    await Bun.write(logFile, entry + "\n", { append: true })
  }
  
  return {
    event: async ({ event }) => {
      await logEvent({ type: event.type, data: event })
    },
    
    "tool.execute.after": async (input, output) => {
      await logEvent({
        type: "tool.executed",
        tool: input.tool,
        sessionID: input.sessionID,
        duration: output.metadata?.duration,
      })
    },
    
    "chat.message": async (input, output) => {
      await logEvent({
        type: "message.sent",
        sessionID: input.sessionID,
        agent: input.agent,
        partsCount: output.parts.length,
      })
    },
  }
}
```

---

### Custom tool with progress updates

Create interactive tools with progress indicators:

```ts title=".opencode/plugin/long-running-task.ts"
import type { Plugin } from "@opencode-ai/plugin"
import { tool } from "@opencode-ai/plugin"

export const LongRunningTask: Plugin = async (ctx) => {
  return {
    tool: {
      process_large_dataset: tool({
        description: "Process a large dataset with progress updates",
        args: {
          dataPath: tool.schema.string().describe("Path to dataset"),
          batchSize: tool.schema.number().default(100),
        },
        async execute(args, context) {
          const items = await loadDataset(args.dataPath)
          const total = items.length
          let processed = 0
          let output = `Processing ${total} items...\n\n`
          
          // Check for cancellation
          if (context.abort.aborted) {
            return "Task cancelled"
          }
          
          for (let i = 0; i < total; i += args.batchSize) {
            const batch = items.slice(i, i + args.batchSize)
            await processBatch(batch)
            
            processed += batch.length
            const percent = Math.round((processed / total) * 100)
            output += `Progress: ${processed}/${total} (${percent}%)\n`
            
            // Check for cancellation between batches
            if (context.abort.aborted) {
              output += "\nTask cancelled by user"
              return output
            }
          }
          
          output += "\nâœ“ Processing complete!"
          return output
        },
      }),
    },
  }
}

async function loadDataset(path: string): Promise<any[]> {
  // Load dataset implementation
  return []
}

async function processBatch(items: any[]): Promise<void> {
  // Process batch implementation
}
```

---

### Multi-provider authentication

Add authentication for multiple providers:

```ts title=".opencode/plugin/multi-auth.ts"
import type { Plugin } from "@opencode-ai/plugin"

export const MultiAuth: Plugin = async (ctx) => {
  return {
    auth: {
      provider: "custom-service",
      loader: async (auth, provider) => {
        // Transform stored auth into provider options
        const token = await auth()
        return {
          headers: {
            Authorization: `Bearer ${token.token}`,
          },
        }
      },
      methods: [
        {
          type: "api",
          label: "API Key",
          prompts: [
            {
              type: "text",
              key: "apiKey",
              message: "Enter your API key",
              validate: (value) => {
                if (!value.startsWith("sk-")) {
                  return "API key must start with 'sk-'"
                }
                return undefined
              },
            },
          ],
          async authorize(inputs) {
            // Validate API key with service
            const response = await fetch("https://api.service.com/validate", {
              headers: { Authorization: `Bearer ${inputs?.apiKey}` },
            })
            
            if (!response.ok) {
              return { type: "failed" }
            }
            
            return {
              type: "success",
              key: inputs?.apiKey || "",
            }
          },
        },
        {
          type: "oauth",
          label: "OAuth Sign In",
          prompts: [
            {
              type: "select",
              key: "environment",
              message: "Select environment",
              options: [
                { label: "Production", value: "prod" },
                { label: "Staging", value: "staging" },
              ],
            },
          ],
          async authorize(inputs) {
            const env = inputs?.environment || "prod"
            const authUrl = `https://auth.service.com/oauth?env=${env}`
            
            return {
              method: "code",
              url: authUrl,
              instructions: "Sign in and copy the authorization code",
              async callback(code) {
                // Exchange code for token
                const response = await fetch("https://auth.service.com/token", {
                  method: "POST",
                  body: JSON.stringify({ code }),
                })
                
                const data = await response.json()
                
                if (!response.ok) {
                  return { type: "failed" }
                }
                
                return {
                  type: "success",
                  access: data.access_token,
                  refresh: data.refresh_token,
                  expires: Date.now() + data.expires_in * 1000,
                }
              },
            }
          },
        },
      ],
    },
  }
}
```

---

### Working with the OpenCode SDK client

Use the SDK client to interact with OpenCode programmatically:

```ts title=".opencode/plugin/sdk-integration.ts"
import type { Plugin } from "@opencode-ai/plugin"
import { tool } from "@opencode-ai/plugin"

export const SDKIntegration: Plugin = async (ctx) => {
  const { client } = ctx
  
  return {
    tool: {
      summarize_session: tool({
        description: "Generate a summary of the current session",
        args: {
          sessionID: tool.schema.string().describe("Session ID to summarize"),
        },
        async execute(args, context) {
          // Get session messages
          const session = await client.session.get(args.sessionID)
          
          // Get all messages in session
          const messages = await client.message.list({
            sessionID: args.sessionID,
          })
          
          // Create summary using AI
          const summary = await client.session.message.create({
            sessionID: args.sessionID,
            content: "Summarize this session in 3 bullet points",
          })
          
          return `Session Summary:\n${summary.content}`
        },
      }),
      
      create_subsession: tool({
        description: "Create a subsession for a specific task",
        args: {
          parentID: tool.schema.string(),
          task: tool.schema.string(),
        },
        async execute(args, context) {
          // Create child session
          const newSession = await client.session.create({
            parentID: args.parentID,
            agent: "build",
            model: "anthropic/claude-3-5-sonnet-20241022",
          })
          
          // Send initial message
          await client.session.message.create({
            sessionID: newSession.id,
            content: args.task,
          })
          
          return `Created subsession: ${newSession.id}`
        },
      }),
    },
  }
}
```

---

## Plugin templates and starters

To get started quickly, check out these plugin templates:

- [opencode-plugin-template](https://github.com/zenobi-us/opencode-plugin-template/) - Official plugin template with TypeScript setup
- [awesome-opencode](https://github.com/awesome-opencode/awesome-opencode) - Curated list of plugins and resources

## Testing plugins

Test your plugin during development:

```bash
# Load plugin from local file
cat > .opencode/opencode.json << EOF
{
  "plugin": ["file:///absolute/path/to/your/plugin.ts"]
}
EOF

# Start OpenCode to test
opencode
```

For faster iteration, plugins in `.opencode/plugin/` are automatically loaded without config changes.

## Best practices

- **Error handling**: Always handle errors gracefully and provide helpful messages
- **Performance**: Cache expensive operations and avoid blocking initialization
- **Security**: Validate all inputs and be careful with file operations
- **Types**: Use TypeScript for better development experience and fewer bugs
- **Documentation**: Add clear descriptions to custom tools so the AI understands when to use them
- **Testing**: Test plugins with different scenarios before publishing
- **Dependencies**: Pin dependency versions for reproducibility
